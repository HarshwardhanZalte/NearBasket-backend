# .github/workflows/deploy.yml
name: ğŸš€ Deploy NearBasket

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ’¬ Notify Deployment Start
      run: |
        curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "text": "ğŸš€ *NearBasket Deployment Started*\n\nğŸŒ¿ Branch: `${{ github.ref_name }}`\nğŸ‘¤ By: ${{ github.actor }}\nğŸ“ Commit: `${{ github.event.head_commit.message }}`\n\nğŸ“Š <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Progress>"
          }' \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"

    - name: ğŸš€ Trigger Render Deployment
      run: |
        curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"

    - name: â³ Wait for Deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 120  # Wait 2 minutes

    - name: ğŸ’¬ Notify Deployment Success
      if: success()
      run: |
        curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "text": "âœ… *NearBasket Deployment Successful*\n\nğŸŒ¿ Branch: `${{ github.ref_name }}`\nğŸ‘¤ By: ${{ github.actor }}\nâ±ï¸ Duration: ~2 minutes\n\nğŸ“Š <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
          }' \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"

    - name: ğŸ’¬ Notify Deployment Failure
      if: failure()
      run: |
        curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "text": "âŒ *NearBasket Deployment Failed*\n\nğŸŒ¿ Branch: `${{ github.ref_name }}`\nğŸ‘¤ By: ${{ github.actor }}\nğŸ’¥ Status: Failed\n\nğŸ“Š <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
          }' \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"
